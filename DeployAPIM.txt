
# Login to Azure 
Connect-AzAccount

# Create resource group
$resGroupName = "APIM-rg" 
$location = "EastUS"         
New-AzResourceGroup -Name $resGroupName -Location $location

# Create NSGs 
$apimRule1 = New-AzNetworkSecurityRuleConfig -Name apim-in -Description "APIM inbound" `
    -Access Allow -Protocol Tcp -Direction Inbound -Priority 100 -SourceAddressPrefix `
    ApiManagement -SourcePortRange * -DestinationAddressPrefix VirtualNetwork -DestinationPortRange 3443
$apimNsg = New-AzNetworkSecurityGroup -ResourceGroupName $resGroupName -Location $location -Name `
    "NSG-APIM" -SecurityRules $apimRule1


# Create subnet config for API-M
$apimSubnet = New-AzVirtualNetworkSubnetConfig -Name "apimSubnet" -NetworkSecurityGroup $apimNsg -AddressPrefix "10.0.10.0/24"

# Create VNET and assign subnets
$vnet = New-AzVirtualNetwork -Name "APIM-Vnet" -ResourceGroupName $resGroupName `
  -Location $location -AddressPrefix "10.0.0.0/16" -Subnet $apimSubnet

# Assign subnet variables
$apimSubnetData = $vnet.Subnets[0]


# ------------- Deploy API Management  ------------- #


$apimVirtualNetwork = New-AzApiManagementVirtualNetwork -SubnetResourceId $apimSubnetData.Id

# Create an API-M service inside the VNET
$apimServiceName = "Tech-api-Test"                
$apimOrganization = "Tech Connect"          
$apimAdminEmail = "me@gmail.com" 
$apimService = New-AzApiManagement -ResourceGroupName $resGroupName -Location $location -Name $apimServiceName -Organization $apimOrganization -AdminEmail $apimAdminEmail -VirtualNetwork $apimVirtualNetwork -VpnType "Internal" -Sku "Developer"

# Specify cert configuration
$gatewayHostname = "focusapi.maherapi.tk"                            
$portalHostname = "developer.maherapi.tk"                         
$managementHostname = "management.maherapi.tk"                  
$gatewayCertPfxPath = "C:\temp1\focusapi.maherapi.tk.pfx"             
$portalCertPfxPath = "C:\temp1\developer.maherapi.tk.pfx"           
$managementCertPfxPath = "C:\temp1\management.maherapi.tk.pfx"  
$gatewayCertPfxPassword = "P@ssw0rd"       
$portalCertPfxPassword = "P@ssw0rd"       
$managementCertPfxPassword = "P@ssw0rd"
    
$certGatewayPwd = ConvertTo-SecureString -String $gatewayCertPfxPassword -AsPlainText -Force
$certPortalPwd = ConvertTo-SecureString -String $portalCertPfxPassword -AsPlainText -Force
$certManagementPwd = ConvertTo-SecureString -String $managementCertPfxPassword -AsPlainText -Force

# Create and set the hostname configuration objects for the proxy and portal

$gatewayHostnameConfig = New-AzApiManagementCustomHostnameConfiguration -Hostname $gatewayHostname `
  -HostnameType Proxy -PfxPath $gatewayCertPfxPath -PfxPassword $certGatewayPwd

$portalHostnameConfig = New-AzApiManagementCustomHostnameConfiguration -Hostname $portalHostname `
  -HostnameType DeveloperPortal -PfxPath $portalCertPfxPath -PfxPassword $certPortalPwd

$managementHostnameConfig = New-AzApiManagementCustomHostnameConfiguration -Hostname $managementHostname `
  # -HostnameType Management -PfxPath $managementCertPfxPath -PfxPassword $certManagementPwd

$apimService.ProxyCustomHostnameConfiguration = $gatewayHostnameConfig
$apimService.PortalCustomHostnameConfiguration = $portalHostnameConfig
$apimService.ManagementCustomHostnameConfiguration = $managementHostnameConfig

Set-AzApiManagement -InputObject $apimService


